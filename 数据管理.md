
## 表格与电子表格

表格数据通常会在像 Excel 这样的电子表格程序中创建和管理。  为了方便后续的分析并确保数据的正确性，数据输入和格式化需要遵循一定的原则。

- **一致性**
- **信息量丰富且适当的命名**
- **无空白单元格**：实际缺失的值（用 `NA`、`.` 或 `-` 等方式编码）
- **完整的文档记录**
- **仅包含数据，不包含分析**
- **数据不是装饰品**
### **主要原则与要点：**

1. **每个变量存储在单独的一列中。**
    - 变量的分配应具有语义意义，每一列应只存储一个变量。
2. **每个观测值存储在单独的一行中。**
    - 每一行应表示一个独立的观测值，不应混合多个观测。
3. **每个单元格只存储一个值。**
    - 单元格中的数据应保持原子性，避免多值存储在同一单元格中。
4. **数据集是由观察单位组成的。**
    - 每个数据集应仅关注一种类型的“观察单位”（如个体、地点、时间点等）。
5. **元数据应分离。**
    - 描述数据的元信息（例如标题、注释等）应与数据本身分开存储。
### **整洁数据的优势：**

- **易于计算：** 整洁数据更容易被分析工具和算法处理。
- **可重复性：** 通过一致性格式化，分析过程能够更轻松地重现。
- **可扩展性：** 数据格式清晰，便于合并、转换和扩展。
- **提高协作效率：** 团队成员可以更快理解数据结构，减少交流障碍。

## 数据一致性

- **特征取值的唯一编码**：每种特征的取值应使用统一的编码方式（例如，“性别女性”始终用“female”表示，而不是有时用“F”、有时用“f”、有时用“female”）。
- **缺失值的统一非数值编码**：所有缺失值应使用一种非数值编码（例如：`NA` 或 `.`，参见“无空白单元格”）。如果需要，单独的列可以用来记录缺失的原因。
- **日期变量的统一格式**：所有日期变量应采用统一格式 `YYYY-MM-DD`（例如：1980-04-01），而不是“1.4.80”或“April 1, 1980”等其他格式。
- **变量命名的一致性**：变量命名应在单个表格内以及多个表格之间保持一致。例如：使用“gewicht-01”、“gewicht-02”……而不是“gewicht1”、“Weight_Day02”等不一致的命名方式。
- **研究对象 ID 的一致命名**：研究对象的 ID 命名应在多个表格间保持一致。
- **文件名的一致命名**：文件名应遵循统一的命名规则。

## 列名作为契约

#### 1. **受控词汇表的概念**

受控词汇表是一组预先定义的单词或短语，用于一致性地描述数据列的含义和用途。这种词汇表可以成为数据生产者和消费者之间隐形的契约，提供以下好处：
- 明确数据的来源和用途
- 增强跨表数据的通用性
- 降低理解和使用新数据的学习成本
#### 2. **分层命名体系**

作者建议通过多层次的命名规则来描述列名，并提供了以下分级示例：

- **第一级：测量类型（Measure Types）**
    - 示例：`ID`（唯一标识符）、`N`（计数）、`AMT`（金额）、`CAT`（分类变量）、`DT`（日期）等。
    - 每种前缀明确规定变量的存储类型和使用规则，如日期始终为 `YYYY-MM-DD` 格式。
- **第二级：测量主体（Measure Subjects）**
    - 示例：`DRIVER`（司机信息）、`RIDER`（乘客信息）、`TRIP`（行程信息）、`ORIG`（起点）、`DEST`（终点）。
- **第三级及更深层次：细节（Details）**
    - 示例：`CITY`（城市名是否全大写）、`LAT` 和 `LON`（经纬度的精度）、`TIME`（时间单位）等。
**组合示例：**  
`ID_DRIVER`（司机的唯一标识符）、`AMT_TRIP_DIST`（行程距离金额）、`CAT_TRIP_TYPE`（行程类型）。
#### 3. **应用场景**

- **数据验证**
    - 列名中的“契约”可以自动化数据验证。例如，`N_` 列应始终为非负整数，`IND_` 列应仅包含 0 或 1。
    - 作者使用了 R 包 **`pointblank`** 演示了如何对数据进行高效验证。
- **数据发现**
    - 受控词汇表使得新数据更易于探索。通过拆分列名并构建层次结构，可以更直观地理解数据表的内容。
    - 文章还展示了使用 R 包 **`collapsibleTree`** 可视化数据字段的层次结构。
- **数据整理**
    - 受控词汇表简化了数据整理工作，因为列名明确了变量的含义。例如，可通过 `dplyr` 等工具轻松选择并操作特定类型的变量，如对所有计数变量求和或对指示变量求均值。
#### 4. **跨语言的通用性**

虽然文章主要以 R 的工具（如 `dplyr` 和 `pointblank`）为例，但这种命名方法是语言无关的。作者还演示了如何在 SQL、Python（`pandas`）等环境中应用类似的模式。
#### 5. **可扩展性**

受控词汇表可以随着数据库的规模和复杂性扩展，用于构建更强大的文档和验证生态系统。作者还提到了两个相关的开源工具：

- **`convo`**：用于维护和应用受控词汇表的 R 包
- **`dbtplyr`**：将 `dplyr` 的选择功能迁移到 SQL 中的工具

